# The version of the OCL
version: 2.0
# The category of the service.
category: container
# The Service provided by the ISV, the name will be shown on the console as a service.
name: K8S-cluster
# The version of the service, if the end-user want to select the version when they want to deploy the service.
serviceVersion: v1.26.2
# For the users may have more than one service, the @namespace can be used to separate the clusters.
description: This is an ehanced k8s cluster services by ISV-A.
namespace: ISV-A
# Icon for the service.
icon: |
  data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACYAAAAmCAYAAACoPemuAAAACXBIWXMAAAsTAAALEwEAmpwYAAAEyUlEQVR4nO1XW2geVRA+52yrVrS2hGjFineleKNVSrHgXVD0RSWgVaoijVJaa0l2Zv+GslBERLw81Ae1XkB8ihaxlZhkZ3ZpUqOFasVLRVG0oGjVqFjx1ja/zNnN/tez+dNEC9KBJcnJmdlvbt/MKnVEDof4g+do5IcM8Hq1jk5Rh12Az9dILxmg/Qa5bB/gv+RMwP73gJAvtoCQD+SA6h/ggxq4V8Hggn8fEPBlGnmrQRpzAmoGEHmr8pNLpx2P58fXaOCkCIAG3qSRNrvv0JhGel0BLZ4inLL2/Ogmg/R2K5FRQIs9jG9t5a5GHlTIl08eEyTzDfKOltOFXDYB3W87cxI6GqlfrUnmtIxLIz07KVBoa2mFRtpwCHrrWwZmgL+org0D9GWB8T0a6FVVGmpXPp+ngbcYpG/dQGhf3d/bWkPVncyrK+o3pd400gu15zSgSvFS+V+DjY5ezwui6w3QO3Wp26zCZIZBHqpy/HfVuXPmhLg84FvqPPrDAIEKorYsxaMG6W57uWvgDI30sAZ6vlIG/JpNT4lOEtAmIBQCtpSxJpkjugbp1/rGmRCYBn7MkYJPVLjlWBWGJkt3SVg+67KteRkg7cpTFsSd9hCjE1TYe5QBHnHYfnBCYE5l5LLQQX6xFC81wJ9mwJ6uRIzeyO5LZO+sAOZlzu6UCVEoYXKMQf7TYWC31IcKonPz+2tHZmnkxw1QWBXxTTaC67adnN+zEeubbYC+d3Tm18XAJAqubvLjlRnwvQaop0Zv7cisinN9s6sbIovUcAb6EZd91cWnOXEZZN+p2NN/qod0c1Vd1IJrIl7AHeObh8JoYaHjAd/uNGQ7qnmof0w9pker2vxvGepWMRieq5H7LIUEUVsKytJFZR1CXq3C5DhnnSFvdEcM+DuH4mcZsGdkENuilrrJ9ainiqs25Aa7+SwDtEoAjzO8pZ/m73i3OaogObugaxJ7J0ypoiFlQNdl0TngYXxjUXoN0lsOytgvEW2iwMvrQvuk8JAQblNmLg21q266KC90TE5XQXRm/v+ugRNtFzdIWStIlng+XWWA7q2lI7664Xpt/XBZ+bRIVhPhGDvP/PgK5W8/3iB9VJWO0aYvD0NjgH4ar0/blenZbVZfVingFbY5aqIWP9AYMeB7nB2TRrDPOoC8seosJ1Y7VqpGS92G4tvxBPRh0Tu8ILq2McJhaOTlbkUas4o2avxBRgFXWt2OXs8AvW+A35Pf5UjupvVJbAd3XdqaOP6cckowPNcgfV5gYI/9POtO5mnkVypzk1ZVFfF9qaPJDA38ojiiSskFBunnArs71Oq+o1WhYHShQf6twMhu2SoqzkRttS+lH1L2z+0tNMjfFNjbK+StWpG0SN1hN8i/1MxMiaKQLSRLbLeOi0+LCngrpQhpqsmIc/3BrGthcIHxozs08FPyU+pNvqYMRHfJfibjS5qh0MFW1p0GsTVC3LxQqV8iVvjBa0dWMt8AbXcU+8vqkKU01G6Qvqrzcp899+OVE6RbnmVCvAKyDvQuu3ROSYL4kpo6Abu1LhdqaAHYUMqPNV/uozXNMxWRod0CiPKED/BBD+gGNZ1iixynCCwgVNMunTtnaqAn7J4v352Tez5O154mn3pH5P8u/wCL4t6vwR2T7QAAAABJRU5ErkJggg==
# Reserved for CSP, aws,azure,ali,huawei and ...
cloudServiceProvider:
  name: flexibleEngine
  regions:
    - name: eu-west-0
      area: Western Europe
    - name: eu-west-1
      area: Western Europe
billing:
  # The business model(`flat`, `exponential`, ...)
  model: flat
  # The rental period (`daily`, `weekly`, `monthly`, `yearly`)
  period: monthly
  # The billing currency (`euro`, `usd`, ...)
  currency: euro
# The flavor of the service, the @category/@name/@version/@flavor can locate the specific service to be deployed.
flavors:
  - name: 1-master-with-3-worker-nodes-normal
    # The fixed price during the period (the price applied one shot whatever is the service use)
    fixedPrice: 40
    # Properties for the service, which can be used by the deployment.
    property:
      worker_nodes_count: 3
      flavor_id: s6.large.4
  - name: 1-master-with-3-worker-nodes-performance
    # The fixed price during the period (the price applied one shot whatever is the service use)
    fixedPrice: 60
    # Properties for the service, which can be used by the deployment.
    property:
      worker_nodes_count: 3
      flavor_id: s6.xlarge.4
  - name: 1-master-with-5-worker-nodes-normal
    # The fixed price during the period (the price applied one shot whatever is the service use)
    fixedPrice: 60
    # Properties for the service, which can be used by the deployment.
    property:
      worker_nodes_count: 5
      flavor_id: s6.large.4
  - name: 1-master-with-5-worker-nodes-performance
    # The fixed price during the period (the price applied one shot whatever is the service use)
    fixedPrice: 80
    # Properties for the service, which can be used by the deployment.
    property:
      worker_nodes_count: 5
      flavor_id: s6.xlarge.4
deployment:
  # kind, Supported values are terraform, pulumi, crossplane.
  kind: terraform
  # Context for deployment: the context including some kind of parameters for the deployment, such as fix,variable.
  # - env: The value of the fix parameters are defined by the ISV with the @value at the initial time.
  # - variable: The value of the variable parameters are defined by the user on the console.
  # The parameters will be used to generate the API of the managed service.
  context:
    - name: OS_ACCESS_KEY
      description: The access key of the FlexibleEngine cloud to use.
      kind: env
      type: string
      mandatory: true
    - name: OS_SECRET_KEY
      description: The secret key of the FlexibleEngine cloud to use.
      kind: env
      type: string
      mandatory: true
    - name: admin_passwd
      description: The admin password of all nodes in the K8S cluster. If the value is empty, will create a random password.
      kind: variable
      type: string
      mandatory: false
      validator: minLength=8|maxLength=16|pattern=^(?=.*?[A-Z])(?=.*?[a-z])(?=.*?[0-9])(?=.*?[#?!@$%^&*-]).{8,16}$
    - name: vpc_name
      description: The vpc name of all nodes in the K8S cluster. If the value is empty, will use the example value to find or create VPC.
      kind: variable
      type: string
      example: "k8s-vpc-default"
      mandatory: false
    - name: subnet_name
      description: The sub network name of all nodes in the K8S cluster. If the value is empty, will use the example value to find or create subnet.
      kind: variable
      type: string
      example: "k8s-subnet-default"
      mandatory: false
    - name: secgroup_name
      description: The security group name of all nodes in the K8S cluster. If the value is empty, will use the example value to find or create security group.
      kind: variable
      type: string
      example: "k8s-secgroup-default"
      mandatory: false
  deployer: |
    variable "flavor_flavor_id" {
      type        = string
      default     = "s6.large.4"
      description = "The flavor_id of all nodes in the k8s cluster."
    }

    variable "flavor_worker_nodes_count" {
      type        = string
      default     = 3
      description = "The worker nodes count in the k8s cluster."
    }

    variable "admin_passwd" {
      type        = string
      default     = ""
      description = "The root password of all nodes in the k8s cluster."
    }

    variable "vpc_name" {
      type        = string
      default     = "k8s-vpc-default"
      description = "The vpc name of all nodes in the k8s cluster."
    }

    variable "subnet_name" {
      type        = string
      default     = "k8s-subnet-default"
      description = "The subnet name of all nodes in the k8s cluster."
    }

    variable "secgroup_name" {
      type        = string
      default     = "k8s-secgroup-default"
      description = "The security group name of all nodes in the k8s cluster."
    }

    data "flexibleengine_vpc_v1" "existing" {
      name  = var.vpc_name
      count = length(data.flexibleengine_vpc_v1.existing)
    }

    data "flexibleengine_vpc_subnet_v1" "existing" {
      name    = var.subnet_name
      count = length(data.flexibleengine_vpc_subnet_v1.existing)
    }

    data "flexibleengine_networking_secgroup_v2" "existing" {
      name  = var.secgroup_name
      count = length(data.flexibleengine_networking_secgroup_v2.existing)
    }

    locals {
      admin_passwd  = var.admin_passwd == "" ? random_password.password.result : var.admin_passwd
      vpc_id        = length(data.flexibleengine_vpc_v1.existing) > 0 ? data.flexibleengine_vpc_v1.existing[0].id : flexibleengine_vpc_v1.new[0].id
      subnet_id     = length(data.flexibleengine_vpc_subnet_v1.existing) > 0 ? data.flexibleengine_vpc_subnet_v1.existing[0].id : flexibleengine_vpc_subnet_v1.new[0].id
      secgroup_id   = length(data.flexibleengine_networking_secgroup_v2.existing) > 0 ? data.flexibleengine_networking_secgroup_v2.existing[0].id : flexibleengine_networking_secgroup_v2.new[0].id
      secgroup_name = length(data.flexibleengine_networking_secgroup_v2.existing) > 0 ? data.flexibleengine_networking_secgroup_v2.existing[0].name : flexibleengine_networking_secgroup_v2.new[0].name
    }

    resource "flexibleengine_vpc_v1" "new" {
      count = length(data.flexibleengine_vpc_v1.existing) == 0 ? 1 : 0
      name  = "${var.vpc_name}-${random_id.new.hex}"
      cidr  = "192.168.0.0/16"
    }

    resource "flexibleengine_vpc_subnet_v1" "new" {
      count      = length(data.flexibleengine_vpc_subnet_v1.existing) == 0 ? 1 : 0
      vpc_id     = local.vpc_id
      name       = "${var.subnet_name}-${random_id.new.hex}"
      cidr       = "192.168.10.0/24"
      gateway_ip = "192.168.10.1"
    }

    resource "flexibleengine_networking_secgroup_v2" "new" {
      count       = length(data.flexibleengine_networking_secgroup_v2.existing) == 0 ? 1 : 0
      name        = "${var.secgroup_name}-${random_id.new.hex}"
      description = "k8s cluster security group"
    }

    resource "flexibleengine_networking_secgroup_rule_v2" "secgroup_rule_0" {
      count             = length(data.flexibleengine_networking_secgroup_v2.existing) == 0 ? 1 : 0
      direction         = "ingress"
      ethertype         = "IPv4"
      protocol          = "tcp"
      port_range_min    = 22
      port_range_max    = 22
      remote_ip_prefix  = "121.37.117.211/32"
      security_group_id = local.secgroup_id
    }

    data "flexibleengine_availability_zones" "osc-az" {}

    resource "random_id" "new" {
      byte_length = 4
    }

    resource "random_password" "password" {
      length           = 12
      upper            = true
      lower            = true
      numeric          = true
      special          = true
      min_special      = 1
      override_special = "#%@"
    }

    resource "flexibleengine_compute_keypair_v2" "keypair" {
      name = "keypair-k8s-${random_id.new.hex}"
    }

    data "flexibleengine_images_image_v2" "image" {
      name        = "K8S-v1.26.2_Centos-7.9"
      most_recent = true
    }

    resource "flexibleengine_compute_instance_v2" "k8s-master" {
      availability_zone  = data.flexibleengine_availability_zones.osc-az.names[0]
      name               = "k8s-master-${random_id.new.hex}"
      flavor_id          = var.flavor_flavor_id
      security_groups    = [ local.secgroup_name ]
      image_id           = data.flexibleengine_images_image_v2.image.id
      key_pair           = flexibleengine_compute_keypair_v2.keypair.name
      network {
        uuid = local.subnet_id
      }
      user_data = <<EOF
        #!bin/bash
        echo root:${local.admin_passwd} | sudo chpasswd
        sudo sh /root/k8s-init.sh true ${local.admin_passwd} ${var.flavor_worker_nodes_count} > /root/init.log
      EOF
    }

    resource "flexibleengine_compute_instance_v2" "k8s-node" {
      count              = var.flavor_worker_nodes_count
      availability_zone  = data.flexibleengine_availability_zones.osc-az.names[0]
      name               = "k8s-node-${random_id.new.hex}-${count.index}"
      flavor_id          = var.flavor_flavor_id
      security_groups    = [ local.secgroup_name ]
      image_id           = data.flexibleengine_images_image_v2.image.id
      key_pair           = flexibleengine_compute_keypair_v2.keypair.name
      network {
        uuid = local.subnet_id
      }
      user_data = <<EOF
        #!bin/bash
        echo root:${local.admin_passwd} | sudo chpasswd
        sudo sh /root/k8s-init.sh false ${local.admin_passwd} ${var.flavor_worker_nodes_count} ${flexibleengine_compute_instance_v2.k8s-master.access_ip_v4} > /root/init.log
        EOF
      depends_on = [
        flexibleengine_compute_instance_v2.k8s-master
      ]
    }

    output "k8s_master_host" {
      value = flexibleengine_compute_instance_v2.k8s-master.access_ip_v4
    }

    output "admin_passwd" {
      value = var.admin_passwd == "" ? nonsensitive(local.admin_passwd) : local.admin_passwd
    }