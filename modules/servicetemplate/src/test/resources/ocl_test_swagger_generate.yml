# The version of the Xpanse description language
version: 1.0
# The category of the service.
category: database
# The Service provided by the ISV, the name will be shown on the console as a service.
name: RDS-MySQL
# The short code of the service provided by ISV. This will be used by the cloud provider internally.
shortCode: sqldb
serviceControllerConfig:
  baseUri: /services/db/mysql
  standardNameMappings:
    serviceId: databaseId
  serviceControllerMode:
    isRegionSpecificController: true
    isSupportsMultipleVersions: false
    isSupportsMultipleCloudProviders: false
    isSupportsMultipleHostingTypes: false

# The version of the service, the end-user can select the version they want to deploy.
serviceVersion: 1.0.0
# For the users may have more than one service, the @serviceVendor can be used to separate the clusters.
description: This is an enhanced MySQL server service by ISV-A.
serviceVendor: ISV-A
# Icon for the service.
icon: |
  data:image/png;base64,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
# Reserved for CSP: HuaweiCloud,FlexibleEngine,OpenstackTestlab,PlusServer,RegioCloud and ...
cloudServiceProvider:
  name: HuaweiCloud
  regions:
    - name: cn-southwest-2
      site: Chinese Mainland
      area: Asia China
    - name: cn-north-4
      site: Chinese Mainland
      area: Asia China
billing:
  # The supported mode of billing (`Fixed`, `Pay per Use`)
  billingModes:
    - Fixed
    - Pay per Use
serviceHostingType: self
# The flavor of the service, the @category/@name/@version/@flavor can locate the specific service to be deployed.
flavors:
  serviceFlavors:
    - name: 2vCPUs-4GB-general
      priority: 2
      # The pricing of the flavor.
      pricing:
        # Used to calculate charges when users select 'pay_per_use' as the billing mode.
        resourceUsage:
          resources:
            - deployResourceKind: vm
              count: 1
              properties:
                cloud_service_type: hws.service.type.rds
                resource_type: hws.resource.type.rds.vm
                resource_spec: rds.mysql.n1.large.2.ha
            - deployResourceKind: volume
              count: 1
              properties:
                cloud_service_type: hws.service.type.rds
                resource_type: ws.resource.type.rds.volume
                resource_spec: rds.mysql.volume.cloudssd.ha
                resource_size: 40
                size_measure_id: 17
            - deployResourceKind: publicIP
              count: 1
              properties:
                cloud_service_type: hws.service.type.vpc
                resource_type: hws.resource.type.bandwidth
                resource_spec: 19_bgp
                resource_size: 5
                size_measure_id: 15
          licensePrices:
            - regionName: any
              siteName: Chinese Mainland
              price:
                cost: 1.90
                currency: CNY
                period: hourly
          markUpPrices:
            - regionName: any
              siteName: Chinese Mainland
              price:
                cost: 1.90
                currency: CNY
                period: hourly
        # Used to calculate charges when users do not select 'pay_per_use' as the billing mode.
        fixedPrices:
          - regionName: any
            siteName: Chinese Mainland
            price:
              cost: 570
              currency: CNY
              period: monthly
        isPriceOnlyForManagementLayer: false
      # Properties for the service, which can be used by the deployment.
      properties:
        flavor_id: rds.mysql.n1.large.2.ha
      features:
        - High Availability
        - Maximum performance
    - name: 2vCPUs-4GB-dedicated
      priority: 1
      # The pricing of the flavor.
      pricing:
        # Used to calculate charges when users select 'pay_per_use' as the billing mode.
        resourceUsage:
          resources:
            - deployResourceKind: vm
              count: 1
              properties:
                cloud_service_type: hws.service.type.rds
                resource_type: hws.resource.type.rds.vm
                resource_spec: rds.mysql.x1.large.2.ha
            - deployResourceKind: volume
              count: 1
              properties:
                cloud_service_type: hws.service.type.rds
                resource_type: ws.resource.type.rds.volume
                resource_spec: rds.mysql.volume.cloudssd.ha
                resource_size: 40
                size_measure_id: 17
            - deployResourceKind: publicIP
              count: 1
              properties:
                cloud_service_type: hws.service.type.vpc
                resource_type: hws.resource.type.bandwidth
                resource_spec: 19_bgp
                resource_size: 5
                size_measure_id: 15
          licensePrices:
            - regionName: any
              siteName: Chinese Mainland
              price:
                cost: 1.90
                currency: CNY
                period: hourly
          markUpPrices:
            - regionName: any
              siteName: Chinese Mainland
              price:
                cost: 1.90
                currency: CNY
                period: hourly
        # Used to calculate charges when users do not select 'pay_per_use' as the billing mode.
        fixedPrices:
          - regionName: any
            siteName: Chinese Mainland
            price:
              cost: 740
              currency: CNY
              period: monthly
        isPriceOnlyForManagementLayer: false
      # Properties for the service, which can be used by the deployment.
      properties:
        flavor_id: rds.mysql.x1.large.2.ha
      features:
        - High Availability
        - Maximum performance
  modificationImpact:
    isDataLost: true
    isServiceInterrupted: true
  isDowngradeAllowed: true
# The contact details of the service.
serviceProviderContactDetails:
  emails: [ "test@test.com" ]
serviceObjects:
  - type: user # type of the object
    objectIdentifier: # Mandatory information for an object.
      name: userName # Mandatory string.
      valueSchema: "" #optional
    handlerType: ansible
    objectsManage:
      - objectActionType: create # Must be also passed as a configuration parameter to SERVICE_CHANGE_DETAILS table. Allowed values must be CREATE, DELETE, UPDATE - create new enum
        modificationImpact:
          isDataLost: false
          isServiceInterrupted: false
        objectHandlerScript:
          # Means should the object manage should run on each node of the specific component or just one.
          runOnlyOnce: true
          changeHandler: instance
          ansibleScriptConfig:
            # Name of the file in the script
            playbookName: "middleware/ansible/database/database-manage.yml"
            # Path to activate virtualenv
            virtualEnv: ""
            # Version of the python
            pythonVersion: "3.10"
            isPrepareAnsibleEnvironment: true
            repoUrl: https://github.com/eclipse-xpanse/xpanse-samples
            branch: main
            # Full path of the requirements file in GIT repo.
            requirementsFile: "requirements.txt"
            # Install roles and collections
            galaxyFile: ""
            # Defines if we need a full inventory request.
            ansibleInventoryRequired: false
        objectParameters:
          - name: username
            dataType: string
            description: username to be created.
            example: test
            valueSchema: null
            sensitiveScope: none
            isMandatory: true
          - name: password
            dataType: string
            description: password of the user to be created.
            example: Stringpwd@123
            valueSchema:
              minLength: 8
              maxLength: 16
              pattern: ^(?=.*?[A-Z])(?=.*?[a-z])(?=.*?[0-9])(?=.*?[#?!@$%^&*-]).{8,16}$
            sensitiveScope: always # store encrypted in xpanse DB.
            isMandatory: true
          - name: databases
            dataType: array # add new value 'array' to type enum.
            description: array of databases used to create new user.
            example: [test]
            valueSchema: null
            sensitiveScope: none # store encrypted in xpanse DB.
            isMandatory: true
            linkedObjectType: database # Means another object of the name mentioned here. Must be validated with OCL register and update.
        controllerApiMethods:
          apiWriteMethodConfigs:
            - methodName: createDBUser
              serviceUri: "/{projectId}/database/user/{databaseId}"
              methodDescription: "create user for the database"
              serviceGroupName: Database User
              serviceOrderType: objectCreate
              methodParameters:
                - name: projectId
                  description: project ID of the tenant.
                  mandatory: true
                  in: "path"
                - name: databaseId
                  description: ID of the database.
                  mandatory: true
                  in: "path"
              requestBody:
                typeName: CreateDatabaseUserRequest
              responseBody:
                typeName: CreateDatabaseUserResponse
          apiReadMethodConfigs:
            - methodName: readDatabaseUser
              serviceUri: "/{projectId}/database/user/{databaseId}/{userId}"
              methodDescription: "service to read users of a database."
              serviceGroupName: Database User
              methodParameters:
                - name: projectId
                  description: project ID of the tenant.
                  mandatory: true
                  in: "path"
                - name: databaseId
                  description: ID of the database.
                  mandatory: true
                  in: "path"
                - name: userId
                  description: ID of the user.
                  mandatory: true
                  in: "path"
              responseBody:
                typeName: DatabaseUserDetails
              standardNameMappings:
                objectId: databaseId
            - methodName: readDatabaseUsers
              serviceUri: "/{projectId}/database/user/{databaseId}"
              methodDescription: "service to read users of a database."
              serviceGroupName: Database User
              methodParameters:
                - name: projectId
                  description: project ID of the tenant.
                  mandatory: true
                  in: "path"
                - name: databaseId
                  description: ID of the database.
                  mandatory: true
                  in: "path"
                - name: userId
                  description: ID of the user.
                  mandatory: false
                  in: "query"
              responseBody:
                typeName: DatabaseUserDetails
              isArray: true
              standardNameMappings:
                objectId: userId
      - objectActionType: update # Must be also passed as a configuration parameter to SERVICE_CHANGE_DETAILS table. Allowed values must be CREATE, DELETE, UPDATE - create new enum
        modificationImpact:
          isDataLost: false
          isServiceInterrupted: false
        objectHandlerScript:
          # Means should the object manage should run on each node of the specific component or just one.
          runOnlyOnce: true
          changeHandler: instance
          ansibleScriptConfig:
            # Name of the file in the script
            playbookName: "middleware/ansible/database/database-manage.yml"
            # Path to activate virtualenv
            virtualEnv: ""
            # Version of the python
            pythonVersion: "3.10"
            isPrepareAnsibleEnvironment: true
            repoUrl: https://github.com/eclipse-xpanse/xpanse-samples
            branch: main
            # Full path of the requirements file in GIT repo.
            requirementsFile: "requirements.txt"
            # Install roles and collections
            galaxyFile: ""
            # Defines if we need a full inventory request.
            ansibleInventoryRequired: false
        objectParameters:
          - name: username
            dataType: string
            description: username to be created.
            example: test
            valueSchema: null
            sensitiveScope: none
            isMandatory: true
          - name: password
            dataType: string
            description: password of the user to be updated.
            example: Strongpwd@123
            valueSchema:
              minLength: 8
              maxLength: 16
              pattern: ^(?=.*?[A-Z])(?=.*?[a-z])(?=.*?[0-9])(?=.*?[#?!@$%^&*-]).{8,16}$
            sensitiveScope: always # store encrypted in xpanse DB.
            isMandatory: true
          - name: databases
            dataType: array # add new value 'array' to type enum.
            description: array of names of databases to create new user.
            example: [test]
            valueSchema: null
            sensitiveScope: none # store encrypted in xpanse DB.
            isMandatory: true
            linkedObjectType: database # Means another object of the name mentioned here. Must be validated with OCL register and update.
      - objectActionType: delete
        modificationImpact:
          isDataLost: false
          isServiceInterrupted: false
        objectHandlerScript:
          # Means should the configuration update run on each node of the specific component or just one.
          runOnlyOnce: true
          changeHandler: instance
          ansibleScriptConfig:
            # Name of the file in the script
            playbookName: "middleware/ansible/database/database-manage.yml"
            # Path to activate virtualenv
            virtualEnv: ""
            # Version of the python
            pythonVersion: "3.10"
            isPrepareAnsibleEnvironment: true
            repoUrl: https://github.com/eclipse-xpanse/xpanse-samples
            branch: main
            # Full path of the requirements file in GIT repo.
            requirementsFile: "requirements.txt"
            # Install roles and collections
            galaxyFile: ""
            # Defines if we need a full inventory request.
            ansibleInventoryRequired: false
        objectParameters:
          - name: username
            dataType: string
            description: username to be created.
            example: test
            valueSchema: null
            sensitiveScope: none
            isMandatory: true
          - name: databases
            dataType: array # add new value 'array' to type enum.
            description: parameter used to create new user.
            example: [test]
            valueSchema: null
            sensitiveScope: none # store encrypted in xpanse DB.
            isMandatory: true
            linkedObjectType: database # Means another object of that type
  - type: database
    objectIdentifier: # Mandatory information for an object.
      name: database name # Mandatory string.
      valueSchema: "" #optional
    handlerType: ansible
    objectsManage:
      - objectActionType: create
        modificationImpact:
          isDataLost: false
          isServiceInterrupted: false
        objectHandlerScript:
          # Means should the configuration update run on each node of the specific component or just one.
          runOnlyOnce: true
          changeHandler: instance
          ansibleScriptConfig:
            # Name of the file in the script
            playbookName: "middleware/ansible/database/database-manage.yml"
            # Path to activate virtualenv
            virtualEnv: ""
            # Version of the python
            pythonVersion: "3.10"
            isPrepareAnsibleEnvironment: true
            repoUrl: https://github.com/eclipse-xpanse/xpanse-samples
            branch: main
            # Full path of the requirements file in GIT repo.
            requirementsFile: "requirements.txt"
            # Install roles and collections
            galaxyFile: ""
            # Defines if we need a full inventory request.
            ansibleInventoryRequired: false
        objectParameters:
          - name: database_name
            dataType: string
            description: name of the database.
            example: test
            valueSchema:
            sensitiveScope: none # store encrypted in xpanse DB.
            isMandatory: true
          - name: character_set
            dataType: string
            description: character set of the database.
            example: utf8mb4
            valueSchema: null
            sensitiveScope: none # store encrypted in xpanse DB.
            isMandatory: true
      - objectActionType: update
        modificationImpact:
          isDataLost: false
          isServiceInterrupted: false
        objectHandlerScript:
          # Means should the configuration update run on each node of the specific component or just one.
          runOnlyOnce: true
          changeHandler: instance
          ansibleScriptConfig:
            # Name of the file in the script
            playbookName: "middleware/ansible/database/database-manage.yml"
            # Path to activate virtualenv
            virtualEnv: ""
            # Version of the python
            pythonVersion: "3.10"
            isPrepareAnsibleEnvironment: true
            repoUrl: https://github.com/eclipse-xpanse/xpanse-samples
            branch: main
            # Full path of the requirements file in GIT repo.
            requirementsFile: "requirements.txt"
            # Install roles and collections
            galaxyFile: ""
            # Defines if we need a full inventory request.
            ansibleInventoryRequired: false
        objectParameters:
          - name: database_name
            dataType: string
            description: name of the database.
            example: test
            valueSchema:
            sensitiveScope: none # store encrypted in xpanse DB.
            isMandatory: true
          - name: character_set
            dataType: string
            description: character set of the database.
            example: utf8mb4
            valueSchema: null
            sensitiveScope: none # store encrypted in xpanse DB.
            isMandatory: true
      - objectActionType: delete
        modificationImpact:
          isDataLost: true
          isServiceInterrupted: false
        objectHandlerScript:
          # Means should the configuration update run on each node of the specific component or just one.
          runOnlyOnce: true
          changeHandler: instance
          ansibleScriptConfig:
            # Name of the file in the script
            playbookName: "middleware/ansible/database/database-container-manage.yml"
            # Path to activate virtualenv
            virtualEnv: ""
            # Version of the python
            pythonVersion: "3.10"
            isPrepareAnsibleEnvironment: true
            repoUrl: https://github.com/eclipse-xpanse/xpanse-samples
            branch: main
            # Full path of the requirements file in GIT repo.
            requirementsFile: "requirements.txt"
            # Install roles and collections
            galaxyFile: ""
            # Defines if we need a full inventory request.
            ansibleInventoryRequired: false
        objectParameters:
          - name: databases
            dataType: array # add new value 'array' to type enum.
            description: array of names of the databases to be deleted.
            example: [test]
            valueSchema: null
            sensitiveScope: none # store encrypted in xpanse DB.
            isMandatory: true
deployment:
  deployerTool:
    # kind, Supported values are terraform, opentofu.
    kind: terraform
    # version, the required version of the deployer tool for executing the deployment scripts.
    version: ">=1.12.0"
  controllerApiMethods:
    apiWriteMethodConfigs:
      - methodName: createDatabase
        serviceUri: "/{projectId}/database"
        methodDescription: "service creates database with the mentioned specifications."
        serviceGroupName: manage databases
        serviceOrderType: deploy
        methodParameters:
          - name: projectId
            description: project ID of the tenant.
            mandatory: true
            in: "path"
        requestBody:
          typeName: CreateDatabaseRequest
          additionalType: |
            {
            "$schema": "https://json-schema.org/draft/2020-12/schema#",
            "title": "UserInfo",
            "type": "object",
            "properties": {
              "id": { "type": "string" },
              "age": { "type": "integer" },
              "tags": {
                "type": "array",
                "items": { "type": "string" }
              }
            }
            }
        responseBody:
          typeName: CreateDatabaseResponse
      - methodName: deleteDatabase
        serviceUri: "/{projectId}/database/{databaseId}"
        methodDescription: "deletes database with mentioned database ID."
        serviceGroupName: manage databases
        serviceOrderType: destroy
        methodParameters:
          - name: projectId
            description: project ID of the tenant.
            mandatory: true
            in: "path"
          - name: databaseId
            description: ID of the database.
            mandatory: true
            in: "path"
        responseBody:
          typeName: DeleteDatabaseResponse
      - methodName: recreateDatabase
        serviceUri: "/{projectId}/database/recreate/{databaseId}"
        methodDescription: "Recreates database. Deletes and creates an new empty one."
        serviceGroupName: manage databases
        serviceOrderType: recreate
        methodParameters:
          - name: projectId
            description: project ID of the tenant.
            mandatory: true
            in: "path"
          - name: databaseId
            description: ID of the database.
            mandatory: true
            in: "path"
        responseBody:
          typeName: RecreateDatabaseResponse
  serviceAvailabilityConfig:
    - displayName: Primary AZ
      varName: primary_az
      mandatory: true
      description: The primary availability zone to deploy the service instance.
    - displayName: Secondary AZ
      varName: secondary_az
      mandatory: true
      description: The secondary availability zone to deploy the service instance. Different from primary_az.
  # Context for deployment: the context including some kind of parameters for the deployment, such as fix_env, fix_variable, env, variable, env_env, env_variable.
  # - fix_env: Values for variable of this type are defined by the managed service provider in the OCL template. Runtime will inject it to the deployment scripts as environment variables. This variable is not visible to the end user.
  # - fix_variable: Values for variable of this type are defined by the managed service provider in the OCL template. Runtime will inject it to the deployment scripts as usual variables. This variable is not visible to the end user.
  # - env: Value for a variable of this type can be provided by end user. If marked as mandatory then end user must provide value to this variable. If marked as optional and if end user does not provide it, then the fallback value to this variable is read by runtime (it can read from other sources, e.g., OS env variables). This variable is injected as an environment variable to the deployment scripts.
  # - variable: Value for a variable of this type can be provided by end user. If marked as mandatory then end user must provide value to this variable. If marked as optional and if end user does not provide it, then the fallback value to this variable is read by runtime (it can read from other sources, e.g., OS env variables). This variable is injected as a regular variable to the deployment scripts.
  # - env_env: Value to this variable is read by runtime (it can read from other sources, e.g., OS env variables) and injected as an environment variable to the deployment scripts. End user cannot see or change this variable.
  # - env_variable: Value to this variable is read by runtime (it can read from other sources, e.g., OS env variables) and injected as a regular variable to the deployment scripts. End user cannot see or change this variable.
  # The parameters will be used to generate the API of the managed service.
  terraformDeployment:
    inputVariables:
      - name: admin_passwd
        description: The admin password of all nodes in the MySQL server instance. If the value is empty, will create a random password.
        kind: variable
        dataType: string
        mandatory: false
        sensitiveScope: always
        valueSchema:
          minLength: 8
          maxLength: 16
          pattern: ^(?=.*?[A-Z])(?=.*?[a-z])(?=.*?[0-9])(?=.*?[#?!@$%^&*-]).{8,16}$
        modificationImpact:
          isDataLost: false
          isServiceInterrupted: true
      - name: vpc_name
        description: The vpc name of all nodes in the MySQL server instance. If the value is empty, will use the default value to find or create VPC.
        kind: variable
        dataType: string
        example: "mysql-vpc-default"
        mandatory: false
        value: "mysql-vpc-default"
        modificationImpact:
          isDataLost: false
          isServiceInterrupted: true
      - name: subnet_name
        description: The sub network name of all nodes in the MySQL server instance. If the value is empty, will use the default value to find or create subnet.
        kind: variable
        dataType: string
        example: "mysql-subnet-default"
        mandatory: false
        value: "mysql-subnet-default"
        modificationImpact:
          isDataLost: false
          isServiceInterrupted: true
      - name: secgroup_name
        description: The security group name of all nodes in the MySQL server instance. If the value is empty, will use the default value to find or create security group.
        kind: variable
        dataType: string
        example: "mysql-secgroup-default"
        mandatory: false
        value: "mysql-secgroup-default"
        modificationImpact:
          isDataLost: false
          isServiceInterrupted: true
    outputVariables:
      - name: admin_passwd
        description: The admin password of the mysql service.
        dataType: string
        sensitiveScope: always
      - name: rds_instance_public_ips
        description: The public ip of the mysql service.
        dataType: string
        sensitiveScope: none
      - name: rds_instance_private_ips
        description: The private ip of the mysql service.
        dataType: string
        sensitiveScope: none
    scriptFiles:
      # The key is the name of the script, the value is the content of the script.
      variables.tf: |
        variable "region" {
          type        = string
          description = "The region to deploy the mysql service instance."
        }
        
        variable "primary_az" {
          type        = string
          description = "The primary availability zone to deploy the mysql service instance."
        }
        
        variable "secondary_az" {
          type        = string
          description = "The secondary availability zone to deploy the mysql service instance."
        }
        
        variable "flavor_id" {
          type        = string
          description = "The flavor_id of the mysql service instance."
        }
        
        variable "db_version" {
          type        = string
          default     = "8.0"
          description = "The version of the database to create in the mysql service instance."
        }
        
        variable "admin_passwd" {
          type        = string
          default     = ""
          description = "The root password of the mysql service instance."
        }
        
        variable "db_name" {
          type        = string
          default     = "test"
          description = "The database name to create in the mysql service instance."
        }
        
        variable "db_port" {
          type        = number
          default     = 3306
          description = "The port of the created database in the mysql service instance."
        }
        
        variable "user_name" {
          type        = string
          default     = "test"
          description = "The user name of the created database."
        }
        
        variable "vpc_name" {
          type        = string
          default     = "rds-vpc-default"
          description = "The vpc name of the mysql service instance."
        }
        
        variable "subnet_name" {
          type        = string
          default     = "rds-subnet-default"
          description = "The subnet name of the mysql service instance."
        }
        
        variable "secgroup_name" {
          type        = string
          default     = "rds-secgroup-default"
          description = "The security group name of the mysql service instance."
        }

      provider.tf: |
        terraform {
          required_providers {
            huaweicloud = {
              source  = "huaweicloud/huaweicloud"
              version = "~> 1.61.0"
            }
          }
        }
        
        provider "huaweicloud" {
          region = var.region
        }

      main.tf: |
        data "huaweicloud_vpcs" "existing" {
          name = var.vpc_name
        }
        
        data "huaweicloud_vpc_subnets" "existing" {
          name = var.subnet_name
        }
        
        data "huaweicloud_networking_secgroups" "existing" {
          name = var.secgroup_name
        }
        
        locals {
          admin_passwd      = var.admin_passwd == "" ? random_password.password.result : var.admin_passwd
          vpc_id            = length(data.huaweicloud_vpcs.existing.vpcs) > 0 ? data.huaweicloud_vpcs.existing.vpcs[0].id : huaweicloud_vpc.new[0].id
          subnet_id         = length(data.huaweicloud_vpc_subnets.existing.subnets)> 0 ? data.huaweicloud_vpc_subnets.existing.subnets[0].id : huaweicloud_vpc_subnet.new[0].id
          secgroup_id       = length(data.huaweicloud_networking_secgroups.existing.security_groups) > 0 ? data.huaweicloud_networking_secgroups.existing.security_groups[0].id : huaweicloud_networking_secgroup.new[0].id
        }
        
        resource "huaweicloud_vpc" "new" {
          count = length(data.huaweicloud_vpcs.existing.vpcs) == 0 ? 1 : 0
          name  = var.vpc_name
          cidr  = "192.168.0.0/16"
        }
        
        resource "huaweicloud_vpc_subnet" "new" {
          count      = length(data.huaweicloud_vpcs.existing.vpcs) == 0 ? 1 : 0
          vpc_id     = local.vpc_id
          name       = var.subnet_name
          cidr       = "192.168.10.0/24"
          gateway_ip = "192.168.10.1"
        }
        
        resource "huaweicloud_networking_secgroup" "new" {
          count       = length(data.huaweicloud_networking_secgroups.existing.security_groups) == 0 ? 1 : 0
          name        = var.secgroup_name
        }
        
        resource "huaweicloud_networking_secgroup_rule" "secgroup_rule_0" {
          count             = length(data.huaweicloud_networking_secgroups.existing.security_groups) == 0 ? 1 : 0
          direction         = "ingress"
          ethertype         = "IPv4"
          protocol          = "tcp"
          port_range_min    = 22
          port_range_max    = 22
          remote_ip_prefix  = "121.37.117.211/32"
          security_group_id = local.secgroup_id
        }
        
        resource "huaweicloud_networking_secgroup_rule" "secgroup_rule_1" {
          count             = length(data.huaweicloud_networking_secgroups.existing.security_groups) == 0 ? 1 : 0
          direction         = "ingress"
          ethertype         = "IPv4"
          protocol          = "tcp"
          port_range_min    = var.db_port
          port_range_max    = var.db_port
          remote_ip_prefix  = "121.37.117.211/32"
          security_group_id = local.secgroup_id
        }
        
        resource "random_id" "new" {
          byte_length = 4
        }
        
        resource "random_password" "password" {
          length           = 12
          upper            = true
          lower            = true
          numeric          = true
          special          = true
          min_special      = 1
          override_special = "#%@"
        }
        
        resource "huaweicloud_vpc_eip" "eip-tf" {
          publicip {
            type = "5_sbgp"
          }
          bandwidth {
            name        = "rds-tf-${random_id.new.hex}"
            size        = 5
            share_type  = "PER"
            charge_mode = "traffic"
          }
        }
        
        
        resource "huaweicloud_rds_instance" "instance" {
          name                = "rds-tf-${random_id.new.hex}"
          flavor              = var.flavor_id
          ha_replication_mode = "async"
          vpc_id              = local.vpc_id
          subnet_id           = local.subnet_id
          security_group_id   = local.secgroup_id
          availability_zone   = [
            var.primary_az,
            var.secondary_az]
        
          db {
            type     = "MySQL"
            version  = var.db_version
            password = local.admin_passwd
            port     = var.db_port
          }
        
          volume {
            type = "CLOUDSSD"
            size = 40
          }
        
          backup_strategy {
            start_time = "01:00-02:00"
            keep_days  = 1
          }
        
          parameters {
            name  = "lower_case_table_names"
            value = 1
          }
        }
        
        resource "huaweicloud_vpc_eip_associate" "associated" {
          public_ip  = huaweicloud_vpc_eip.eip-tf.address
          network_id = local.subnet_id
          fixed_ip   = huaweicloud_rds_instance.instance.fixed_ip
        }
        
        resource "huaweicloud_rds_mysql_database" "db" {
          instance_id   = huaweicloud_rds_instance.instance.id
          name          = var.db_name
          character_set = "utf8"
        }
        
        resource "huaweicloud_rds_mysql_account" "user" {
          instance_id = huaweicloud_rds_instance.instance.id
          name        = var.user_name
          password    = local.admin_passwd
        }
        
        resource "huaweicloud_rds_mysql_database_privilege" "privilege" {
          instance_id = huaweicloud_rds_instance.instance.id
          db_name     = var.db_name
          users {
            name     = var.user_name
            readonly = false
          }
          depends_on = [
            huaweicloud_rds_mysql_database.db, huaweicloud_rds_mysql_account.user
          ]
        }
        
        resource "huaweicloud_rds_mysql_binlog" "test" {
          instance_id            = huaweicloud_rds_instance.instance.id
          binlog_retention_hours = 6
        }

      outputs.tf: |
        output "rds_instance_public_ips" {
          value = huaweicloud_vpc_eip.eip-tf.address
        }
        
        output "rds_instance_private_ips" {
          value = join(",", huaweicloud_rds_instance.instance.private_ips)
        }
        
        output "admin_passwd" {
          value = var.admin_passwd == "" ? nonsensitive(local.admin_passwd) : local.admin_passwd
        }

resourceStateManage:
  isResourceStateControllable: true
  controllerApiMethods:
    apiWriteMethodConfigs:
      - methodName: startDatabase
        serviceUri: "/{projectId}/database/start/{databaseId}"
        methodDescription: "service starts the database."
        serviceGroupName: manage databases
        serviceOrderType: serviceStart
        methodParameters:
          - name: projectId
            description: project ID of the tenant.
            mandatory: true
            in: "path"
          - name: databaseId
            description: ID of the database.
            mandatory: true
            in: "path"
        responseBody:
          typeName: StartDatabaseResponse
      - methodName: stopDatabase
        serviceUri: "/{projectId}/database/stop/{databaseId}"
        methodDescription: "service stops the database."
        serviceGroupName: manage databases
        serviceOrderType: serviceStop
        methodParameters:
          - name: projectId
            description: project ID of the tenant.
            mandatory: true
            in: "path"
          - name: databaseId
            description: ID of the database.
            mandatory: true
            in: "path"
        responseBody:
          typeName: StopDatabaseResponse
      - methodName: restartDatabase
        serviceUri: "/{projectId}/database/restart/{databaseId}"
        methodDescription: "service restarts the database."
        serviceGroupName: manage databases
        serviceOrderType: serviceRestart
        methodParameters:
          - name: projectId
            description: project ID of the tenant.
            mandatory: true
            in: "path"
          - name: databaseId
            description: ID of the database.
            mandatory: true
            in: "path"
        responseBody:
          typeName: RestartDatabaseResponse
serviceConfigurationManage:
  type: ansible
  configManageScripts:
    # Should be the name available in the deployer script
    - changeHandler: kafka-broker
      # Means should the configuration update run on each node of the specific component or just one.
      runOnlyOnce: false
      ansibleScriptConfig:
        # Name of the file in the script
        playbookName: "middleware/ansible/kafka/kafka-container-manage.yml"
        # Path to activate virtualenv
        virtualEnv: ""
        # Version of the python
        pythonVersion: "3.10"
        repoUrl: https://github.com/eclipse-xpanse/xpanse-samples
        branch: main
        # Full path of the requirements file in GIT repo.
        requirementsFile: "requirements.txt"
        # Install roles and collections
        galaxyFile: ""
        # Defines if we need a full inventory request.
        ansibleInventoryRequired: false
    - changeHandler: zookeeper
      # Means should the configuration update run on each node of the specific component or just one.
      runOnlyOnce: true
      ansibleScriptConfig:
        # Name of the file in the script
        playbookName: "middleware/ansible/kafka/kafka-container-manage.yml"
        # Path to activate virtualenv
        virtualEnv: ""
        # Version of the python
        pythonVersion: "3.10"
        repoUrl: https://github.com/eclipse-xpanse/xpanse-samples
        branch: main
        # Full path of the requirements file in GIT repo.
        requirementsFile: "requirements.txt"
        # Install roles and collections
        galaxyFile: ""
        # Defines if we need a full inventory request.
        ansibleInventoryRequired: false
  configurationParameters:
    - name: kafka_cfg_message_max_bytes
      kind: variable
      dataType: number
      description: Parameters used to configure the Kafka server or client to set the maximum number of bytes for Kafka messages.
      initialValue: 1048576
      managedBy: 'kafka-broker'
      modificationImpact:
        isDataLost: true
        isServiceInterrupted: true
      isReadOnly: false
    - name: kafka_cfg_log_dirs
      kind: variable
      dataType: string
      description: Parameters for the storage location of Kafka log data
      initialValue: /var/lib/kafka/logs
      managedBy: 'kafka-broker'
      modificationImpact:
        isDataLost: true
        isServiceInterrupted: true
      isReadOnly: false
    - name: kafka_cfg_num_io_threads
      kind: variable
      dataType: number
      description: Parameter used to set the number of I/O threads to handle kafka network requests
      initialValue: 8
      managedBy: 'kafka-broker'
      modificationImpact:
        isDataLost: true
        isServiceInterrupted: true
      isReadOnly: false
    - name: kafka_log_flush_interval_messages
      kind: variable
      dataType: number
      description: Kafka's log flush strategy, specifies the parameters that trigger a log flush operation after how many messages are written.
      initialValue: 10000
      managedBy: 'kafka-broker'
      modificationImpact:
        isDataLost: true
        isServiceInterrupted: true
      isReadOnly: false
    - name: kafka_offsets_topic_replication_factor
      kind: variable
      dataType: number
      description: Replication factor configuration parameters for the dedicated topic (offsets topic) used in the Kafka cluster to consume offset information for the consumer storage group
      initialValue: 3
      managedBy: 'kafka-broker'
      modificationImpact:
        isDataLost: true
        isServiceInterrupted: true
      isReadOnly: false
    - name: zookeeper_global_outstanding_limit
      kind: variable
      dataType: number
      description: Clients can submit requests faster than ZooKeeper can process them, especially if there are a lot of clients.
      initialValue: 1000
      managedBy: zookeeper
      modificationImpact:
        isDataLost: true
        isServiceInterrupted: true
      isReadOnly: false
    - name: zookeeper_snap_count
      kind: variable
      dataType: number
      description: Limits the number of concurrent connections (at the socket level) that a single client, identified by IP
        address, may make to a single member of the ZooKeeper ensemble. This is used to prevent certain classes of
        DoS attacks, including file descriptor exhaustion. The default is 60. Setting this to 0 entirely removes the
        limit on concurrent connections.
      initialValue: 1000
      managedBy: zookeeper
      modificationImpact:
        isDataLost: true
        isServiceInterrupted: true
      isReadOnly: false
  controllerApiMethods:
    apiWriteMethodConfigs:
      - methodName: updateDatabaseConfiguration
        serviceUri: "/{projectId}/database/config/{databaseId}"
        methodDescription: "service to update configuration of the database."
        serviceGroupName: manage database configuration
        serviceOrderType: configChange
        methodParameters:
          - name: projectId
            description: project ID of the tenant.
            mandatory: true
            in: "path"
          - name: databaseId
            description: ID of the database.
            mandatory: true
            in: "path"
        requestBody:
          typeName: DatabaseConfiguration
        responseBody:
          typeName: DatabaseConfigurationUpdateResponse
    apiReadMethodConfigs:
      - methodName: readDatabaseConfiguration
        serviceUri: "/{projectId}/database/config/{databaseId}"
        methodDescription: "service to update configuration of the database."
        serviceGroupName: manage database configuration
        methodParameters:
          - name: projectId
            description: project ID of the tenant.
            mandatory: true
            in: "path"
          - name: databaseId
            description: ID of the database.
            mandatory: true
            in: "path"
        responseBody:
          typeName: DatabaseConfigurationDetails
serviceActions:
  - name: upgrade
    type: ansible
    actionManageScripts:
      - changeHandler: kafka-broker
        runOnlyOnce: false
        ansibleScriptConfig:
          playbookName: "middleware/ansible/kafka/kafka-container-manage.yml"
          virtualEnv: ""
          pythonVersion: "3.10"
          repoUrl: https://github.com/eclipse-xpanse/xpanse-samples
          branch: main
          requirementsFile: "requirements.txt"
          galaxyFile: ""
          ansibleInventoryRequired: false
    actionParameters:
      - name: inter_broker_protocol_version
        kind: variable
        dataType: string
        description: controls the protocol version used for communication between Kafka Brokers to ensure that the old and new versions of Brokers can communicate normally during the rolling upgrade process.
        initialValue: 3.2
        managedBy: 'kafka-broker'
        modificationImpact:
          isDataLost: true
          isServiceInterrupted: true
        isReadOnly: false
    controllerApiMethods:
      apiWriteMethodConfigs:
        - methodName: upgradeDatabase
          serviceUri: "/{projectId}/database/upgrade/{databaseId}"
          methodDescription: "service to upgrade database."
          serviceGroupName: Upgrade Database
          serviceOrderType: serviceAction
          methodParameters:
            - name: projectId
              description: project ID of the tenant.
              mandatory: true
              in: "path"
            - name: databaseId
              description: ID of the database.
              mandatory: true
              in: "path"
          requestBody:
            typeName: DatabaseUpgradeRequest
          responseBody:
            typeName: DatabaseUpgradeResponse
  - name: backup
    type: ansible
    actionManageScripts:
      - changeHandler: zookeeper
        runOnlyOnce: true
        ansibleScriptConfig:
          playbookName: "middleware/ansible/kafka/kafka-container-manage.yml"
          virtualEnv: ""
          pythonVersion: "3.10"
          repoUrl: https://github.com/eclipse-xpanse/xpanse-samples
          branch: main
          requirementsFile: "requirements.txt"
          galaxyFile: ""
          ansibleInventoryRequired: false
    actionParameters:
      - name: kafka_cfg_message_max_bytes
        kind: variable
        dataType: number
        description: Parameters used to configure the Kafka server or client to set the maximum number of bytes for Kafka messages.
        initialValue: 1048576
        managedBy: 'kafka-broker'
        modificationImpact:
          isDataLost: true
          isServiceInterrupted: true
        isReadOnly: false
    controllerApiMethods:
      apiWriteMethodConfigs:
        - methodName: backupDatabase
          serviceUri: "/{projectId}/database/backup/{databaseId}"
          methodDescription: "service to backup database."
          serviceGroupName: Backup Database
          serviceOrderType: serviceAction
          methodParameters:
            - name: projectId
              description: project ID of the tenant.
              mandatory: true
              in: "path"
            - name: databaseId
              description: ID of the database.
              mandatory: true
              in: "path"
          requestBody:
            typeName: DatabaseBackupRequest
          responseBody:
            typeName: DatabaseBackupResponse
